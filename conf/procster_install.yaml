# Install Procster on a large number of machines
# Chores before running
# - Install NPM dependencies: npm install
# - Make sure procster config ~/.procster/procster.conf.json exists and is configured
#   - cp procster.conf.json ~/.procster/procster.conf.json
#   - Edit and configure for your environment
#   - Run "make unit" to preview before running ansible
- name: Install procster
  become: yes
  vars:
    mustache: ./node_modules/mustache/bin/mustache
    sysdunit: procster.service
  tasks:
    # Already have this in debug: var=ansible_env.PWD ? {{ lookup('env','PWD') }} ?
    - Detect current dir
      shell: pwd
      register: currdir
    - debug: var=currdir.stdout
    - name: Generate Config
      # ./node_modules/mustache/bin/mustache - ./tmpl/default.installer.menu.mustache > /tmp/default
      shell: cat ~/.procster/procster.conf.json | '{{ mustache }}' -  conf/procster.service.mustache > ./procster.service
      delegate_to: localhost
    # If unit file is on NFS we can have systemd symlink it
    # Otherwise copy to host local service account homedir (?)
    - Enable and start service
      - shell: systemctl enable --now {{ lookup('env','PWD') }}/procster.service
    # TODO: Place to stop
    # procster.service unit should be installed by now
    - Stop Service
      - shell: systemctl stop procster
      - when: 0
